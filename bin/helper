#!/bin/bash

ACTION=$1

if [[ $2 = '-d' ]]; then
  TAG='-debug'
else
  TAG=''
fi

case $ACTION in
build)
  echo build $TAG
  docker build -t homeski/macbot ..
  ;;
run)
  echo run $TAG

  docker network create --driver bridge macbot_nw$TAG

  if [[ -z $TAG ]]; then
    # non-debug
    docker run -d -p 3001:8080 --name macbot   --network=macbot_nw --env DB_NAME=influxdb homeski/macbot
    docker run -d -p 8081:80 -p 9081:8083  --name=influxdb --network=macbot_nw                        homeski/grafana-influxdb
  else
    # debug
    docker run -d -p 3002:8080 --name macbot$TAG   --network=macbot_nw$TAG --env DEBUG=true --env DB_NAME=influxdb$TAG homeski/macbot
    docker run -d -p 8082:80 -p 9082:8083  --name=influxdb$TAG --network=macbot_nw$TAG                          homeski/grafana-influxdb
  fi
  ;;
test)
  echo test $TAG
  if [[ -z $TAG ]]; then
    # non-debug
    curl -d '{"text":"macbot"}' -H "Content-Type: application/json" localhost:3001/groupme
  else
    # debug
    curl -d '{"text":"macbot"}' -H "Content-Type: application/json" localhost:3002/groupme
  fi
  ;;
kill)
  echo kill $TAG
  docker kill macbot$TAG
  docker rm macbot$TAG
  ;;
killdb)
  echo killdb $TAG
  docker kill influxdb$TAG
  docker rm influxdb$TAG
  ;;
watch)
  echo watch $TAG
  docker logs -f macbot$TAG
  ;;
reload)
  echo reload $TAG
  ./helper build $2
  ./helper kill $2
  ./helper run $2
  ./helper watch $2
  ;;
*)
  echo 'unknown command. use build | run | test | kill | reload | watch and -d for debug'
  ;;
esac
